# amvera.yml ─ конфигурация кластера
apiVersion: v1

build:               # ← используется докер-сборка из вашего Dockerfile
  context: .
  dockerfile: Dockerfile

run:
  # Gunicorn слушает 8000, наружу публикуем 80
  containerPort: "8000"
  servicePort: "80"

  # Health-probe, чтобы Ingress не ставил 502
  healthCheck:
    path: /health/
    port: 8000
    method: GET
    intervalSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Переменные окружения для Django / React
  env:
    - name: DEBUG
      value: "1"
    - name: SECRET_KEY           # ← подтянется из секрета в UI
      valueFrom:
        secretKeyRef:
          name: SECRET_KEY
          key: SECRET_KEY
    - name: ALLOWED_HOSTS
      value: ".amvera.io,.amvera-run.app"
    - name: CSRF_TRUSTED_ORIGINS
      value: "https://bugetslok-seredinsky.amvera.io,https://*.amvera-run.app"
    - name: MEDIA_URL
      value: "/materials/"
    - name: VITE_BACKEND_ORIGIN
      value: "https://bugetslok-seredinsky.amvera.io"

  # Оставляем один Persistent Volume —- хранит файлы и SQLite
  volumes:
    - name: data
      mountPath: /app/materials        # Django MEDIA_ROOT
      size: 1Gi
    - name: db
      mountPath: /app/db.sqlite3       # SQLite файл
      size: 1Gi